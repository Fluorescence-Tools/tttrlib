# Change pip's cache directory to be inside the project directory since we can
# only cache local items.
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  DEPLOY_VARIABLE: "nightly"
  MINICONDA_VERSION: "latest"
  MAMBA_VERSION: "0.10"

stages:
- build
- test
- deploy
- Trigger-cross-projects

build:linux:
  stage: build
  tags:
    - linux
  image: continuumio/miniconda3:latest
  before_script:
    - apt update -yq && apt -yq install build-essential doxygen   
  script:
    - echo "I am the build stage."
    - source activate base
    - conda install mamba=$MAMBA_VERSION boa conda-verify -c conda-forge    
    # # Take care that linked against same libraries as IMP - now managed via conda recipe
    # - conda create -n imp python=3.8 && conda activate imp && mamba install imp -c salilab
    # - if ($(python -c "import IMP;exit(IMP.__version__ > '2.15.0')")); then cp conda-recipe/meta_imp_2.14.yaml conda-recipe/meta.yaml; fi
    # - conda activate base
    # Build the recipe
    - conda config --add channels salilab
    - conda mambabuild conda-recipe --output-folder bld-dir
  artifacts:
    expire_in: 7 days
    paths:
      - bld-dir/

test:linux:
  variables:
    MINICONDA_OS: "Linux"
  stage: test
  tags:
    - linux
  image: ubuntu:latest
  before_script:
    - export DEBIAN_FRONTEND=noninteractive
    - apt update -yq
    - apt install -yq procps wget git git-lfs
    # Download and install miniconda
    - wget https://repo.continuum.io/miniconda/Miniconda3-$MINICONDA_VERSION-$MINICONDA_OS-x86_64.sh -O miniconda.sh
    - bash miniconda.sh -b -p $HOME/miniconda
    - export PATH="$HOME/miniconda/bin:$PATH"
    # setup conda to always accept commands
    - conda config --set always_yes yes --set changeps1 no
  script:
    - echo "I am a test stage job for debian, running on docker"
    - source activate base
    - conda install mamba=$MAMBA_VERSION -c conda-forge
    - |
      conda config --add channels salilab
      conda config --add channels "file://`pwd`/bld-dir"
    - git clone https://gitlab.peulen.xyz/tpeulen/tttr-data --depth 1
    - conda create -n test
    - conda activate test
    - mamba install python tttrlib nose scipy
    - |
      cd test
      nosetests

deploy:conda:
  stage: deploy
  image: continuumio/miniconda3:latest
  tags:
    - linux
  dependencies:
    - build:linux
  script:
    - echo "I am a deploy stage."
    - source activate
    - conda install anaconda-client
    - echo $CI_COMMIT_REF_NAME
    - if [[ "$CI_COMMIT_REF_NAME" == "master" ]]; then ANACONDA_LABEL=main; else ANACONDA_LABEL=nightly; fi
    - anaconda -t ${ANACONDA_API_TOKEN} upload -l ${ANACONDA_LABEL} -u ${CONDA_USER} --force bld-dir/linux-64/*.tar.bz2

# deploy:doc:
#   stage: deploy
#   image: continuumio/miniconda3:latest
#   tags:
#     - linux
#   dependencies:
#     - build:linux
#   before_script:
#     - apt-get update -qy
#     # Latex documentation
#     - apt-get install -y texlive-latex-recommended texlive-latex-extra texlive-fonts-recommended latexmk
#     # Make command
#     - apt-get install -y build-essential lftp
#     # see: https://bugs.launchpad.net/ubuntu/+source/lftp/+bug/1904601
#     # - apt-get install -y lftp=4.8.1-1ubuntu0.1 --allow-downgrades
#   script:
#     - echo "I am a deploy stage... Building documentation."
#     - source activate base
#     - conda config --add channels "file://`pwd`/bld-dir"
#     - cd doc
#     - conda install mamba -c conda-forge
#     - mamba env update --file environment.yml
#     - conda activate doc
#     - echo "I am a deploy stage... Uploading documentation."
#     - if [[ "$CI_COMMIT_REF_NAME" == "master" ]]; then make all; else exit; fi
#     - lftp -c "set sftp:auto-confirm yes; set sftp:connect-program \"ssh -a -x -o UserKnownHostsFile=/dev/null\"; open -u $FTP_USERNAME,$FTP_PASSWORD sftp://peulen.xyz:2222; mirror -Rnev --delete ./_build/html/stable/ ./www/tttrlib/; bye"

# Downstream projects
tttrconvert:
  stage: Trigger-cross-projects
  trigger: tpeulen/tttrconvert

fit2x:
  stage: Trigger-cross-projects
  trigger: tpeulen/fit2x

clsmview:
  stage: Trigger-cross-projects
  trigger: tpeulen/clsmview

scikit-fluorescence:
  stage: Trigger-cross-projects
  trigger: tpeulen/scikit-fluorescence
