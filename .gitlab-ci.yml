stages:
- build
- test
- deploy

.build: &build
  stage: build
  artifacts:
    paths:
      - bld-dir/
.build_posix: &build_posix
  <<: *build
  script:
    - ./tools/build.sh
.build:lnx: &build_lnx
  <<: *build_posix
  before_script:
    - source "/opt/conda/etc/profile.d/conda.sh"
    - conda activate /opt/conda/
    - git submodule update --init --recursive --remote
build:lnx_x86:
  <<: *build_lnx
  image:
    name: condaforge/linux-anvil-cos7-x86_64
    entrypoint: [ "/bin/bash", "-i", "-c" ]
  tags:
    - x86_64
build:lnx_ppc64le:
  <<: *build_lnx
  image:
    name: condaforge/linux-anvil-ppc64le
    entrypoint: [ "/bin/bash", "-i", "-c" ]
  tags:
    - ppc64le
build:lnx_aarch64:
  <<: *build_lnx
  image:
    name: condaforge/linux-anvil-aarch64
    entrypoint: [ "/bin/bash", "-i", "-c" ]
  tags:
    - aarch64
build:osx:
  <<: *build
  image: sickcodes/docker-osx:latest
  tags:
    - x86_64
  script:
    - chmod -R 777 /home/arch
    - curl -LO "https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-MacOSX-x86_64.sh"
    - sh Mambaforge-MacOSX-x86_64.sh -p /home/arch/miniconda -b
    - PATH=/home/arch/miniconda/bin:${PATH}
    - conda install git
    - git submodule update --init --recursive --remote
    - ./tools/build.sh
build:windows:
  <<: *build
  image: mambaforge:vs16
  tags:
    - win
  script:
    - cmd.exe
    - conda activate base
    - .\tools\build.bat

test:linux:
  stage: test
  tags:
    - linux
  image: condaforge/mambaforge
  needs: ["build:lnx_x86"]
  before_script:
    - apt update -yq
    - apt install -yq procps wget git git-lfs
  script:
    - git clone https://gitlab.peulen.xyz/skf/tttrlib
    - git submodule update --init --recursive --remote
    - source activate base
    - conda config --add channels "file://`pwd`/bld-dir"
    - mamba install python tttrlib nose scipy
    - git lfs clone https://gitlab.peulen.xyz/skf/tttr-data --depth 1
    - |
      nosetests test

deploy:conda:
  stage: deploy
  image: condaforge/mambaforge
  tags:
    - linux
  before_script:
    - git submodule update --init --recursive --remote
  script:
    - ./tools/deploy.sh

deploy:doc:
   stage: deploy
   image: condaforge/mambaforge
   tags:
     - linux
   needs: ["build:lnx_x86"]
   before_script:
     - export DEBIAN_FRONTEND=noninteractive
     - export TZ=Europe/Berlin
     - apt-get update -qy
     - apt-get install -qy git git-lfs texlive-latex-recommended texlive-latex-extra texlive-fonts-recommended latexmk build-essential lftp
   script:
     - source activate base
     - git clone https://gitlab.peulen.xyz/skf/tttrlib && cd tttrlib
     - git lfs clone https://gitlab.peulen.xyz/skf/tttr-data --depth 1
     - cd doc && mamba env update --file environment.yml
     - conda activate doc
     - if [[ "$CI_COMMIT_REF_NAME" == "master" ]]; then sphinx-build -b html . _build; else exit; fi
     #- lftp -c "set sftp:auto-confirm yes; set sftp:connect-program \"ssh -a -x -o UserKnownHostsFile=/dev/null\"; open -u $FTP_USERNAME,$FTP_PASSWORD sftp://peulen.xyz:2222; mirror -Rnev --delete ./_build/ ./www/docs.peulen.xyz/tttrlib/; bye"
     - lftp -d -e "set sftp:auto-confirm yes; set ssl:verify-certificate no; set sftp:connect-program \"ssh -a -x -o UserKnownHostsFile=/dev/null\ StrictHostKeyChecking=no; open sftp://peulen.xyz:2222; user $FTP_USERNAME $FTP_PASSWORD; mirror -Rnev --verbose --delete _build/ /www/docs.peulen.xyz/tttrlib/; bye"


## Downstream projects
#tttrconvert:
#  stage: Trigger-cross-projects
#  trigger: chisurf/tttrconvert
#
#fit2x:
#  stage: Trigger-cross-projects
#  trigger: skf/fit2x
#
## Depends via fit2x on tttrlib
##scikit-fluorescence:
##  stage: Trigger-cross-projects
##  trigger: skf/scikit-fluorescence
