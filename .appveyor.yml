platform:
  - amd64
image: Visual Studio 2015

environment:
  matrix:
    - PYTHON: "C:\\Miniconda3-x64"

## For debugging uncomment the lines below
#init:
#  - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

install:
  ##################################################
  # Install packages for docs.
  # i#4000: choco fails to download doxygen.portable so we install ourselves:
  - appveyor DownloadFile http://doxygen.nl/files/doxygen-1.8.17.windows.x64.bin.zip
  - 7z x doxygen-1.8.17.windows.x64.bin.zip -oc:\projects\install\doxygen > nul
  - set PATH=c:\projects\install\doxygen;%PATH%
  - "SET PATH=%PYTHON%;%PYTHON%\\Scripts;%PATH%"
  ##################################################
  # Build conda package
  - git submodule update --init --recursive
  - conda config --set always_yes yes --set changeps1 no
  - conda update -q conda
  - conda create -n build python=3.7 git conda-build anaconda-client numpy conda-verify ripgrep
  - activate build
  - conda config --add channels tpeulen
  - conda build conda-recipe

# to run your custom scripts instead of automatic tests
test_script:
  - conda install --use-local tttrlib
  # scipy is used in some tests
  - conda install nose coverage scipy
  - cmd: echo %CD%
  - cmd: cd C:\projects\tttrlib\test\
  - cmd: echo %CD%
  - nosetests
  - cd ..

# scripts to run after tests
deploy_script:
  - if "%APPVEYOR_REPO_BRANCH%" == "master" exit 0
  - anaconda -t %ANACONDA_API_TOKEN% upload -u %CONDA_USER% -l nightly C:\Miniconda3-x64\envs\build\conda-bld\win-64\tttrlib-*.tar.bz2 --force

build: off

## For debugging uncomment the lines below
#on_finish:
#  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

notifications:
  - provider: Email
    to:
      - thomas.otavio.peulen@gmail.com
    on_build_success: false
    on_build_failure: true
    on_build_status_changed: true
